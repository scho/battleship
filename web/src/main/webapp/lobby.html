<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Battleship</title>
    <meta name="description" content="Battleship - Yet anther browser version of this famous game.">
    <meta name="author" content="Georg Meyer">

    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">

</head>

<body>

<div class="header">
    <h1>Battleship - Lobby</h1>
    <span id="player-info"></span>
    <button id="logout-button" class="btn btn-secondary">Logout</button>
</div>

<div class="container">
    <div class="row">
        <div id="content" class="span12>">
            <table id="openGames" class="table table-striped">
                <thead>
                <tr>
                    <td>Opponent</td>
                    <td>Link</td>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
            <button id="reload-games-button" class="btn btn-secondary">Reload</button>
            <button id="create-game-button" class="btn btn-secondary">Create Game</button>
        </div>
    </div>
</div>

<script src="lib/jquery-1.11.1.js"></script>
<script src="lib/bootstrap.js"></script>

<script type="text/javascript">
$(document).ready(function() {
    $('#create-game-button').click(function(event){

        $.ajax({
            type: 'PUT',
            url: '/api/games/create'
        }).done(function(data){
            window.location = "/game.html#" + data;
        });

        event.preventDefault();
    });

    $('#logout-button').click(function(event){

        $.ajax({
            type: 'POST',
            url: '/api/players/logout'
        }).done(function(data){
            window.location = "/";
        });

        event.preventDefault();
    });

    $('#reload-games-button').click(function(event){
        window.loadGames();

        event.preventDefault();
    });

    window.loadGames = function () {
        $.ajax({
            type: 'GET',
            url: '/api/games',
            dataType: 'json'
        }).done(function(openGames){
            var tbody = $('#openGames tbody').first();
            tbody.empty();
            openGames.map(function(openGame){
                tbody.append('<tr>' +
                    '<td>' + openGame.opponentName + '</td>' +
                    '<td><a href="#" onclick="(function(e){' +
                            'e.preventDefault();' +
                            'joinGame(\'' + openGame.gameId + '\');' +
                         '})(event);">Join</a></td>' +
                    '</tr>');
            });
        }).fail(function(){
            console.log("Loading of games failed.");
        });
    }

    window.joinGame = function(gameId){
        $.ajax({
            type: 'POST',
            url: '/api/games/' + gameId + '/join'
        }).done(function(data){
            window.location = "/game.html#" + data;
        });

        event.preventDefault();

    };

    window.loadPlayerInfo = function(gameId){
        $.ajax({
            type: 'GET',
            url: '/api/players/info',
            dataType: 'json'
        }).done(function(player){
            $('#player-info').text('Logged in as ' + player.name + ' - ' + player.gamesWon + ' games won, ' + player.gamesLost + ' games lost');
        }).fail(function(){
            window.location = "/";
        });
    };

    window.loadPlayerInfo();
    window.loadGames();

});





</script>


</body>
</html>